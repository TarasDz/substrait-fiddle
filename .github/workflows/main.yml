name: Deploy api + docker

on: 
  push: 
    branches: [ DVO-4886-use-docker-compose ]
  workflow_dispatch:

env:
  VITE_SESSION_SECRET: ${{ secrets.VITE_SESSION_SECRET }}
  DUCKDB_POOL_SIZE: 5
  REMOTE_USER: ${{ secrets.BASE_USER }}


jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: Update and upgrade packages
      run: sudo apt update && sudo apt upgrade -y
    - name: Install Docker
      run: sudo apt install docker docker-ce docker-ce-cli containerd.io -y
    - name: Install Docker.io
      run: sudo apt install docker.io -y
    - name: Install Docker-Compose
      run: sudo apt install docker-compose -y
    # - name: Stop and Start Docker service
    #   run: systemctl stop docker && systemctl start docker
    - name: Install NPM
      run: sudo apt install npm -y
    - name: Create deployment user
      run: sudo useradd -m -b /var/lib -G docker ${{ secrets.DEPLOY_USERNAME }}
    - name: Configure deployment directory
      run: sudo mkdir /var/lib/${{ secrets.DEPLOY_USERNAME }}/.ssh
    - name: Change ownership and permissions
      run: sudo chown ${{ secrets.DEPLOY_USERNAME }}:${{ secrets.DEPLOY_USERNAME }} /var/lib/${{ secrets.DEPLOY_USERNAME }}/.ssh && sudo chmod 0500 /var/lib/${{ secrets.DEPLOY_USERNAME }}/.ssh
    - name: Add SSH key
      run: echo "${{ secrets.DEPLOY_PUB_KEY }}" | ssh ${{ secrets.BASE_USER }}@${{ secrets.DEPLOY_HOST_DNS }} 'cat >> /var/lib/${{ secrets.DEPLOY_USERNAME }}/.ssh/authorized_keys'
    - name: Configure key
      run: sudo install -o ${{ secrets.DEPLOY_USERNAME }} -g ${{ secrets.DEPLOY_USERNAME }} -m 0600 ${{ secrets.DEPLOY_PUB_KEY }} /var/lib/${{ secrets.DEPLOY_USERNAME }}/.ssh/authorized_keys
    
    - uses: alex-ac/github-action-ssh-docker-compose@master
      name: Docker-Compose Remote Deployment
      with:
        ssh_host: ${{ secrets.DEPLOY_HOST_DNS }}
        ssh_private_key: ${{ secrets.DEPLOY_SSH_KEY }}
        ssh_user: ${{ secrets.DEPLOY_USERNAME }}
        docker_compose_prefix: testing

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v3
#     - run: rm -rf .git
#     # - name: Install dependencies
#     #   run: make install-dep
#     - name: Build Docker image
#       run: docker-compose up
#       env:
#         ARGS: -rlgoDzvc -i --delete
#         SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
#         REMOTE_HOST: ${{ secrets.DEPLOY_HOST_DNS }}
#         REMOTE_USER: ${{ secrets.DEPLOY_USERNAME }}
#         SCRIPT_AFTER: sudo chown -R www-data:www-data ${{ secrets.DEPLOY_TARGET_DIR }} && sudo supervisorctl start substrait-fiddle:*
#         TARGET: ${{ secrets.DEPLOY_TARGET_DIR }}
          # ssh_host: ${{ secrets.DEPLOY_HOST_DNS }}
          # ssh_user: ${{ secrets.DEPLOY_USERNAME }}
          # ssh_private_key: ${{ secrets.DEPLOY_SSH_KEY }}
          # docker_compose_prefix: substrait-fiddle
          # ssh_host_public_key: ${{ secrets.DEPLOY_PUBLIC_KEY }}
          # ssh_jump_public_key: ${{ secrets.DEPLOY_PUBLIC_KEY }}
